---
- name: Workstation setup (Windows native)
  hosts: localhost
  connection: local
  gather_facts: true

  tasks:
    - name: Set Windows path facts
      ansible.builtin.set_fact:
        win_fonts_dir: "{{ ansible_env.USERPROFILE }}/AppData/Local/Microsoft/Windows/Fonts"
        win_temp_dir: "{{ ansible_env.TEMP }}/win-fonts-setup"

    # ------------------------------------------------------------------------
    # Install applications via winget
    # ------------------------------------------------------------------------

    - name: Install Visual Studio Code
      ansible.builtin.command:
        cmd: winget install --id Microsoft.VisualStudioCode --silent --accept-package-agreements --accept-source-agreements
      register: vscode_install
      changed_when: "'successfully installed' in vscode_install.stdout | lower"
      failed_when: vscode_install.rc != 0 and 'already installed' not in vscode_install.stdout | lower

    - name: Install 7-Zip
      ansible.builtin.command:
        cmd: winget install --id 7zip.7zip --silent --accept-package-agreements --accept-source-agreements
      register: sevenzip_install
      changed_when: "'successfully installed' in sevenzip_install.stdout | lower"
      failed_when: sevenzip_install.rc != 0 and 'already installed' not in sevenzip_install.stdout | lower

    # ------------------------------------------------------------------------
    # Install JetBrains Mono Nerd Font
    # ------------------------------------------------------------------------

    - name: Check if JetBrains Mono already installed in Windows fonts
      ansible.builtin.find:
        paths: "{{ win_fonts_dir }}"
        patterns: "JetBrainsMonoNerd*FontMono*.ttf"
      register: win_jetbrains_mono

    - name: Create temporary fonts download directory
      when: win_jetbrains_mono.matched == 0
      ansible.builtin.file:
        path: "{{ win_temp_dir }}"
        state: directory
        mode: "0755"

    - name: Download JetBrains Mono Nerd Font
      when: win_jetbrains_mono.matched == 0
      ansible.builtin.get_url:
        url: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.1/JetBrainsMono.zip
        dest: "{{ win_temp_dir }}/JetBrainsMono.zip"
        mode: "0644"

    - name: Extract JetBrains Mono Nerd Font
      when: win_jetbrains_mono.matched == 0
      ansible.builtin.unarchive:
        src: "{{ win_temp_dir }}/JetBrainsMono.zip"
        dest: "{{ win_temp_dir }}/"

    - name: Install fonts via Shell.Application CopyHere
      when: win_jetbrains_mono.matched == 0
      ansible.builtin.command:
        cmd: >-
          powershell -Command
          "$shell = New-Object -ComObject Shell.Application;
          $fontsFolder = $shell.Namespace(0x14);
          Get-ChildItem '{{ win_temp_dir }}' -Filter 'JetBrainsMonoNerd*FontMono*.ttf' |
          ForEach-Object { $fontsFolder.CopyHere($_.FullName) }"
      changed_when: true
