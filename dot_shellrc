#!/usr/bin/env sh

# ----------------------------------------------------------------------------
# shellrc is sourced by both .bashrc and .zshrc
# Keep this file POSIX-compatible (no bash or zsh specific syntax)
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Prompt (shell-agnostic)
# ----------------------------------------------------------------------------
# _PROMPT_ID    = user@host color: red for root, magenta for remote (SSH), cyan for local
#                 green = no dotfiles installed (system default) â€” intentionally unused here
# _PROMPT_INFO  = path color: always blue
# _PROMPT_RESET = reset color
if [ "$(id -u)" = "0" ]; then
  _PROMPT_ID=$(printf '\033[1;31m')    # bold red (root)
elif [ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ] || [ -n "$SSH_CONNECTION" ]; then
  _PROMPT_ID=$(printf '\033[1;35m')    # bold magenta (remote)
else
  _PROMPT_ID=$(printf '\033[1;36m')    # bold cyan (local)
fi
_PROMPT_INFO=$(printf '\033[34m')    # blue (path)
_PROMPT_RESET=$(printf '\033[0m')    # reset

# ----------------------------------------------------------------------------
# Colors (shell-agnostic)
# ----------------------------------------------------------------------------
# BSD ls (macOS): CLICOLOR enables color, LSCOLORS defines the scheme
# Format: each pair = fg/bg for: dir symlink socket pipe exec block char setuid setgid sticky-dir other-writable-dir
export CLICOLOR=1
export LSCOLORS="ExGxFxDxCxEgEdxbxgxcxd"  # bold: blue dir, cyan link, magenta socket, green exec

# LS_COLORS: used by GNU ls, grep, fd, tree, and many other tools
if command -v dircolors >/dev/null 2>&1; then
  eval "$(dircolors -b)"
else
  # Fallback for macOS (no dircolors): sensible defaults for tools that read LS_COLORS
  export LS_COLORS='di=1;34:ln=1;36:so=1;35:pi=33:ex=1;32:bd=1;33:cd=1;33:su=37;41:sg=30;43:tw=30;42:ow=34;42'
fi

# Colorize commands that support "--color=auto"
alias grep='grep --color=auto'
if diff --color=auto /dev/null /dev/null >/dev/null 2>&1; then
  alias diff='diff --color=auto'
fi
if ls --color=auto /dev/null >/dev/null 2>&1; then
  alias ls='ls --color=auto'
fi

# ----------------------------------------------------------------------------
# Editor (shell-agnostic)
# ----------------------------------------------------------------------------
export EDITOR=vim

# ----------------------------------------------------------------------------
# History (shell-agnostic)
# ----------------------------------------------------------------------------
export HISTSIZE=10000

# ----------------------------------------------------------------------------
# PATH (OPTIONAL)
# ----------------------------------------------------------------------------
# Add $HOME/.local/bin to front of PATH (if exists)
test -d "$HOME/.local/bin" && export PATH="$HOME/.local/bin:$PATH"

# ----------------------------------------------------------------------------
# pyenv (OPTIONAL)
# ----------------------------------------------------------------------------
if [ -d "$HOME/.pyenv" ]; then
  export PYENV_ROOT="$HOME/.pyenv"
  export PATH="$PYENV_ROOT/bin:$PATH"
  eval "$(pyenv init -)"
fi

# ----------------------------------------------------------------------------
# nvm (OPTIONAL)
# ----------------------------------------------------------------------------
if [ -s "/opt/homebrew/opt/nvm/nvm.sh" ]; then
  export NVM_DIR="$HOME/.nvm"
  \. "/opt/homebrew/opt/nvm/nvm.sh"
elif [ -s "/usr/local/opt/nvm/nvm.sh" ]; then
  export NVM_DIR="$HOME/.nvm"
  \. "/usr/local/opt/nvm/nvm.sh"
fi

# ----------------------------------------------------------------------------
# ssh-agent (OPTIONAL â€” requires smallstep)
# ----------------------------------------------------------------------------
if command -v step >/dev/null 2>&1; then
  if ! pgrep -u "$USER" ssh-agent >/dev/null 2>&1; then
    eval "$(ssh-agent -s)" >/dev/null
  fi
fi

# ----------------------------------------------------------------------------
# Kitty terminal (OPTIONAL)
# Use kitten ssh to propagate terminfo to remote hosts 
# ----------------------------------------------------------------------------
if command -v kitten >/dev/null 2>&1; then
  alias ssh='kitten ssh'
fi
